---
title: "tPRiors-dynamic-report"
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
keep_md: yes
output: html_document
runtime: shiny
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## General information

This report has automatically been generated by the shiny web-application tPRiors as an R Markdown document based on your data input and prior selection. The web-application can be found at <https://kpateras.shinyapps.io/tPRiors>. We advice users that after observing the results of this report to avoid re-updating their prior beliefs to avoid hampering the credibility of these results.

------------------------------------------------------------------------

The following section describes your input. During set-up the user assumed that:

1.  `r input$ID_SingleMultiple` modelled,
2.  `r input$ID_ZeroPrevalence`, zero prevalence was modeled,
3.  between the Apparent and True prevalence the `r input$ID_TrueApp` was modelled and
4.  (the) `r input$ID_MeanMedianMode` was used to elicitate prior knowledge.

------------------------------------------------------------------------

If the true prevalence (inline equation test: ($\pi_{t}$) is modelled the following relation is utilized to acquire its posterior distribution, inline equation test: $\pi_{a} = \pi_{t}\cdot S_{e}(1-\pi_{t})\cdot (1-S_{p})$, where inline equation test: $S_{p},S_{e}$ denotes the specificity and sensitivity of the diagnostic test and inline equation test: $\pi_{a}$ the apparent prevalence.

------------------------------------------------------------------------

------------------------------------------------------------------------

## The elicited prior

The selected prior distribution of the `r input$ID_TrueApp` has the following descriptive characteristics and density plot.

```{r echo=FALSE}
paste0("Summary of ",input$ID_TrueApp," Beta(",round(fb$atotalbeta,4),",", round(fb$btotalbeta,4),") prior")
sample_beta<-rbeta(n = 10000,fb$atotalbeta, fb$btotalbeta)
summary(sample_beta)
```

```{r echo = FALSE}
renderPlotly({
    x<-seq(0,1,length.out = 10000)
    fig1 <- plot_ly(x = ~x, y = ~dbeta(x = x,shape1 = fb$atotalbeta, shape2 = fb$btotalbeta), type = 'scatter', mode = 'lines', colors = "#e69138", fill = 'tozeroy', width=NULL, height=NULL)
    fig1 <- fig1 %>% layout(xaxis = list(title = 'Beta'), yaxis = list(title = 'Density'))
    fig1

  })
```
<br>
<br>
------------------------------------------------------------------------

------------------------------------------------------------------------

## The data
A summary of the input data is provided below

```{r echo=FALSE}
#"Position of Data Table"
paste0("If modelled, the assumed probability for non-zero prevalence was set equal to ", input$tau0)
dataTableOutput("dtst")

```

------------------------------------------------------------------------

------------------------------------------------------------------------

## The model

```{r echo=FALSE}
renderPlotly({
    Model1.mcmc_df<-data.frame(Model1.mcmc[[1]])
    post <-  data.frame(density=data.frame(density=Model1.mcmc_df$main.pstar.rep))
    pri <-  data.frame(density=rbeta(10000,shape1 = fb$atotalbeta,shape2=fb$btotalbeta))
    #Lik <- data.frame(density=rbinom(n = 10000, size =  input$n, prob = input$y/input$n)/input$n)
    post$Distribution <- 'posterior' ; pri$Distribution <- 'prior' #; Lik$Distribution <- 'likelihood'
    triple <- rbind(post, pri)#, Lik)
    p1<-ggplot(triple, aes(density, fill = Distribution)) +
      xlim(0, 1)+ theme(legend.position="top")+
      geom_density(alpha = 0.2, adjust=0.2)
    ggplotly(p1)
  })
round(summary(Model1.mcmc_df$main.pstar.rep),2)

paste0("The probability that the posterior prevalence is higher than ", input$perVal," equals to")
Model1.mcmc_df<-data.frame(Model1.mcmc[[1]])
sum(Model1.mcmc_df$main.pstar.rep>input$perVal)/length(Model1.mcmc_df$main.pstar.rep)
```

### Study-level boxplot and numerical summaries of posterior prevalence samples

```{r echo=FALSE}
renderPlotly({
  data_out<<-Model1.mcmc_df
data_out_sub<-data_out[,grepl( "sub" , names( data_out ) )]
data_out_sub_wide<-gather(data_out_sub, group, prevalence, names( data_out_sub ), factor_key=TRUE)
levels(data_out_sub_wide$group)<-1:length(levels(data_out_sub_wide$group))

 #data_out_sub_wide %>%
p2 <-  ggplot( aes(x=group, y=prevalence,fill=group),data=data_out_sub_wide) +
  geom_boxplot()
#  geom_violin() +
  # xlab("class") +
  theme(legend.position="none") +
  xlab("")
  # #p2
  ggplotly(p2)
})
```

```{r echo=FALSE}
data_out<<-Model1.mcmc_df
data_out_sub<-data_out[,grepl( "sub" , names( data_out ) )]
data_out_sub_wide<-gather(data_out_sub, group, prevalence, names( data_out_sub ), factor_key=TRUE)
levels(data_out_sub_wide$group)<-1:length(levels(data_out_sub_wide$group))

T_prev_sub_mean<-aggregate(data_out_sub_wide$prevalence, list(data_out_sub_wide$group), mean)[,2]
T_prev_sub_med<-aggregate(data_out_sub_wide$prevalence, list(data_out_sub_wide$group), median)[,2]
data.frame(T_prev_mean=round(T_prev_sub_mean,3),LL95=round(T_prev_sub_mean-1.96*sqrt(T_prev_sub_mean*(1-T_prev_sub_mean)/temp_data$n),3),UL95=round(T_prev_sub_mean+1.96*sqrt(T_prev_sub_mean*(1-T_prev_sub_mean)/temp_data$n),3),
           T_prev_median=round(T_prev_sub_med,3),
           Q025=round(aggregate(data_out_sub_wide$prevalence, list(data_out_sub_wide$group), FUN = function(x) quantile(x,c(0.025,0.975)))[,2][,1],3),
           Q975=round(aggregate(data_out_sub_wide$prevalence, list(data_out_sub_wide$group), FUN = function(x) quantile(x,c(0.025,0.975)))[,2][,2],3))

```


## Predictions
Predictive distribution of $y$ for a single new study with $n=100$.
```{r echo=FALSE}
    S<-ggs(Model1.mcmc)
    ggs_density(S,family = "y.pre")
```

The predictive prevalence mean of a future study equals to 
```{r echo=FALSE} 
R.Temp3=data.frame(Model1.mcmc[[1]])
round(mean(R.Temp3$main.pstar.rep),3)
```

The probability that the prevalence equals to 0 (zero) equals to 
```{r echo=FALSE} 
R.Temp1=Model1.mcmc_df
round(mean(R.Temp1$pre.pequal0),3)

------------------------------------------------------------------------

------------------------------------------------------------------------


## Diagnostics 

```{r echo=FALSE, figures-side, fig.show="hold", out.width="50%"}
    oldw <- getOption("warn") # silence warnings for diagnostic plots
    options(warn = -1)
    S<-ggs(Model1.mcmc,family = "main")
    ggs_histogram(S,family = "main")
    ggs_density(S,family = "main")
    ggs_traceplot(S,family = "main")
    ggs_running(S,family = "main")
    ggs_compare_partial(S,family = "main")
    ggs_autocorrelation(S,family = "main")
    options(warn = oldw) # turn back warnings to previous level
# Model1fit<-as.mcmc(Model1.mcmc)
# traceplot(Model1.mcmc)
# autocorr.plot(Model1fit)
# geweke.plot(Model1fit)
```

------------------------------------------------------------------------



```{r echo=FALSE, figures-side2, fig.show="hold", out.width="50%"}
    oldw2 <- getOption("warn") # silence warnings for diagnostic plots ## Diagnostics - stydy level
    options(warn = -1)
    S2<-ggs(Model1.mcmc,family = "sub")
   # ggs_histogram(S2,family = "sub")
  #  ggs_density(S2,family = "sub")
  #  ggs_traceplot(S2,family = "sub")
  #  ggs_running(S2,family = "sub")
  #  ggs_compare_partial(S2,family = "sub")
  #  ggs_autocorrelation(S2,family = "sub")
    options(warn = oldw2) # turn back warnings to previous level
# Model1fit<-as.mcmc(Model1.mcmc)
# traceplot(Model1.mcmc)
# autocorr.plot(Model1fit)
# geweke.plot(Model1fit)
```


------------------------------------------------------------------------

End of tPRiors report.

------------------------------------------------------------------------

# Instructions for using the resulted .rData files

Users can further access the analysis with the following .rData files. We provide below three files under the tabs; 1) Input, 2) Model and 3) Output. The user should first open R or Rstudio and then search and open the .rData file of interest through the tab <files> or through the load function. The input data in R form can be loaded by "load("~/.../InputData.RData")". The final JAGS model can be loaded in R via "load("~/.../JagsModel.rData")", while the MCMC samples can be directly loaded in R via "load(~/.../Model1.mcmc.RData), where "..." stands for the local directory path where the file of interest has been placed.

# Working with the <Model.mcmc> object

The Model.mcmc object contains MCMC samples produced by the current Bayesian analysis set-up. When loaded in R the user can perform further descriptive analysis and check more diagnostics, which is especially important in multiple populations where the number of parameters becomes very large and inference may become unstable. We provide a number of potentially useful descriptive and diagnostic plots from the CODA package alone or in combination with the ggmcmc R package.

traceplot(Model1.mcmc)

autocorr.plot(Model1.mcmc)

geweke.plot(Model1.mcmc)


When working with multiple population models that contain many parameters it can be convinient to use the family option of the ggs function group. First load the data files, then install and load the ggmcmc library. In the case of multiple populations if family="main" then, only main parameters are being plotted, if family="sub" then only study parameters are selected, while if family="pre" then predictive parameters are selected and returned. Some examples are provided below. 


S2<-ggs(Model1.mcmc)

ggs_histogram(S2,family = "main") # Histograms (Main)

ggs_density(S2,family = "main") # Density plots for main parameters 

ggs_density(S2,family = "sub") # Density plots for study prevalences

ggs_density(S2,family = "pre") # Density plots for predictive parameters

ggs_traceplot(S2,family = "main") # Trace plots (Main)

ggs_running(S2,family = "main") # Running means plots (Main)

ggs_compare_partial(S2,family = "main") # Partial chain comparison plots (Main)

ggs_autocorrelation(S2,family = "main") # Autocorrelation plots (Main)
