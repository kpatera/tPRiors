---
title: "TPpre_Report"
author: "Konstantinos Pateras"
date: "21/01/2021"
output: html_document
params: 
  n: NA
  metric: NA
  pop: NA
  pre: NA
  zero: NA
  
runtime: shiny
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#  tPriors dynamic report

## General information

This report has automatically been generated by the shiny web-application tPriors as an R Markdown document based on your data input and prior selection. The web-application can be found at <http://kpateras.shinyapps.io/tPriors>. We advice users that after observing the results of this report to avoid re-updating their prior beliefs to avoid hampering the credibility of these results.

------------------------------------------------------------------------

The following section describes your input. During set-up the user assumed that:

1.  `r input$ID_SingleMultiple` modelled,
2.  `r input$ID_ZeroPrevalence`, zero prevalence was modeled,
3.  between the Apparent and True prevalence the `r input$ID_TrueApp` was modelled and
4.  (the) `r input$ID_MeanMedianMode` was used to elicitate prior knowledge.

------------------------------------------------------------------------

If the true prevalence (inline equation test: $\pi_{t}$) is modelled the following relation is utilized to acquire its posterior distribution, inline equation test: $\pi_{a} = \pi_{t}\cdot S_{e}(1-\pi_{t})\cdot (1-S_{p})$, where inline equation test: $S_{p},S_{e}$ denotes the specificity and sensitivity of the diagnostic test and inline equation test: $\pi_{a}$ the apparent prevalence.

------------------------------------------------------------------------

------------------------------------------------------------------------

## The elicited prior

The selected prior distribution of the `r input$ID_TrueApp` has the following descriptive characteristics and density plot.

```{r echo=FALSE, eval=(metric!="Percentiles" & pop=="Single population")}
sample_beta<-rbeta(n = 10000,priors$prior$a, priors$prior$b)
summary(sample_beta)
```

```{r echo=FALSE, eval=(metric!="Percentiles" & pop!="Single population")}
sample_beta<-rbeta(n = 10000,priors$prior$a, priors$prior$b)
summary(sample_beta)
```

```{r echo=FALSE, eval=(metric=="Percentiles" & pop!="Single population")}
sample_beta<-rbeta(n = 10000,priors$prior$a, priors$prior$b)
summary(sample_beta)
```

```{r echo = FALSE, eval=(metric!="Percentiles" & pop=="Single population")}
renderPlotly({
    # find beta based on prior knowledge
 if(input$ID_MeanMedianMode=="Mean"){
      fb<<-findbeta2(themedian=input$PriorMetric, percentile=input$Percentile1,lower.v=input$lower.value, percentile.value=input$PercentileValue1)
    }else if(input$ID_MeanMedianMode=="Median"){
      fb<<-findbeta2(themedian=input$PriorMetric, percentile=input$Percentile1,lower.v=input$lower.value, percentile.value=input$PercentileValue1)
    }else if(input$ID_MeanMedianMode=="Mode"){
      fb<<-findbeta2(themode =input$PriorMetric, percentile=input$Percentile1,lower.v=input$lower.value, percentile.value=input$PercentileValue1)
    }
  
    x<-seq(0,1,length.out = 2000)
    #plot(x,dbeta(x = x,dbeta(x = x,shape1 = fb$a,shape2 = fb$b),shape1 = fb$a,shape2 = fb$b),type = "l",lwd=3,ylab = "Density Beta")
    priors$prior<<-list(a=fb$a,b=fb$b)
    fig <- plot_ly(x = ~x, y = ~dbeta(x = x,shape1 = fb$a,shape2 = fb$b), type = 'scatter', mode = 'lines', fill = 'tozeroy',
                   width=input$dimens, height=input$dimens)
    fig <- fig %>% layout(xaxis = list(title = 'Beta'),
                          yaxis = list(title = 'Density'))
    fig
  })
```

```{r echo = FALSE, eval=(metric!="Percentiles" & pop!="Single population")}
renderPlotly({
 fb<<-findbetamupsi2(themean=input$PriorMean2, percentile=input$Percentile2, 
                        lower.v=input$lower.value2,percentile.value=input$PercentileValue2, 
                        psi.percentile=input$PercentilePsi2, percentile.median=input$PercentileMedian2,
                        percentile95value=input$Percentile95value2)    
    priors$prior<<-list(a=fb$atotalbeta,b=fb$btotalbeta,ab=fb$abeta,bb=fb$bbeta,ag=fb$agamma,bg=fb$bgamma)
    x<-seq(0,1,length.out = 2000)
    # par(mfrow=c(2,1))
    # plot(x,dbeta(x = x,shape1 = fb$abeta,shape2 = fb$bbeta),type = "l",lwd=3,ylab = "Density beta")
    # plot(x,dgamma(x = x,shape = fb$agamma, rate = fb$bgamma),type = "l",lwd=3,ylab = "Density gamma")
    
    fig1 <- plot_ly(x = ~x, y = ~dbeta(x = x,shape1 = fb$atotalbeta, shape2 = fb$btotalbeta), type = 'scatter', mode = 'lines', fill = 'tozeroy', width=input$dimens, height=input$dimens)

    fig1 <- fig1 %>% layout(xaxis = list(title = 'Beta'), yaxis = list(title = 'Density'))
    fig1
    #fig2 <- plot_ly(x = ~x, y = ~dgamma(x = x,shape1 = fb$agamma,shape2 = fb$bgamma), type = 'scatter', mode = 'lines', fill = 'tozeroy', width=800, height=800)
    #fig2 <- fig2 %>% layout(xaxis = list(title = 'Gamma'), yaxis = list(title = 'Density'))
    
    #subplot(fig1, fig2, nrows = 2, margin = 0.04, heights = c(0.5, 0.5))
  })
```

```{r echo = FALSE, eval=(metric=="Percentiles")}
renderPlotly({
    # Find alpha and beta of a beta dist based on percentiles
    fb<<-findbetaqq2(percentile.value1=input$PercentileValue3_1,percentile1=input$Percentile3_1,
                     percentile.value2=input$PercentileValue3_2,percentile2=input$Percentile3_2)
    priors$prior<<-list(a=fb$a,b=fb$b)
    x<-seq(0,1,length.out = 2000)
    #plot(x,dbeta(x = x,shape1 = fb$a,shape2 = fb$b),type = "l",lwd=3,ylab = "Density Beta")
    fig2 <- plot_ly(x = ~x, y = ~dbeta(x = x,shape1 = fb$a, shape2 = fb$b), type = 'scatter', mode = 'lines', fill = 'tozeroy',
                    width=input$dimens, height=input$dimens)
    fig2 <- fig2 %>% layout(xaxis = list(title = 'Beta'), yaxis = list(title = 'Density'))
    fig2  
  })
```
<br>
<br>
------------------------------------------------------------------------

------------------------------------------------------------------------

## The data

A summary of the input data is provided below

```{r echo=FALSE, eval=(pop=="Single population")}
paste0("The sample size was set equal to ", input$n,", while the positive subjects were set equal to ",input$y)
paste0("The observed (apparent) prevalence was equal to ", 100*round(input$y/input$n,4),"%")
```

```{r echo=FALSE, eval=(pop!="Single population")}
head(matrix(NA,20,2))
```
------------------------------------------------------------------------

------------------------------------------------------------------------

## The model

<!--Apparent, single, no zero -->

```{r echo=FALSE, eval=(pre=="Apparent prevalence")}
renderPlot({
      paste("EISAI EDO APP")

    source("Functions/Jags_ApparentPre.R",local=TRUE)
    plot(density(Model1.mcmc[[1]][,1]),ylim=c(0,100),xlim=c(0,1),lwd=5, main = "Posterior (black) and Prior (red) distribution of APpre")
    lines(1:1000/1000,dbeta(seq(0,1,length.out = 1000),fb$a,fb$b),type = "l",col="red",lwd=5)
 # post <-  data.frame(density=data.frame(density=Model1.mcmc[[1]][,1])[,1])
 #   # pri <-  data.frame(density=rbeta(10000,shape1 = priors$prior$a,shape2=priors$prior$b))
 #    Lik <- data.frame(density=rbinom(n = 10000, size =  input$n, prob = input$y/input$n))
 #    post$dist <- 'posterior' ; pri$dist <- 'prior' ; Lik$dist <- 'likelihood'
 #    triple <- rbind(post, pri, Lik)
 # 
 #    p1<-ggplot(triple, aes(density, fill = dist)) + geom_density(alpha = 0.2)+
 #    xlim(0, 1)+ theme(legend.position="top")
 #    p1
  })
```

<!--True, single, no zero -->

```{r echo=FALSE, eval=(pre=="True prevalence")}
renderPlot({
    paste("EISAI EDO TRUE")
    source("Functions/Jags_TruePre.R",local=TRUE)
    post <-  data.frame(density=data.frame(density=Model1.mcmc[[1]][,1])[,1])
    pri <-  data.frame(density=rbeta(10000,shape1 = priors$prior$a,shape2=priors$prior$b))
    Lik <- data.frame(density=rbinom(n = 10000, size =  input$n, prob = input$y/input$n))
    post$dist <- 'posterior' ; pri$dist <- 'prior' ; Lik$dist <- 'likelihood'
    triple <- rbind(post, pri, Lik)
    p1<-ggplot(triple, aes(density, fill = dist)) + geom_density(alpha = 0.2)+
      xlim(0, 1)+ theme(legend.position="top")
    p1
   # S <- ggs(Model1.mcmc)
   # p2<-ggs_traceplot(S)
   # gridExtra::grid.arrange(p1,p2,ncol=2)
    #plot(density(Model1.mcmc[[1]][,1]),ylim=c(0,100),xlim=c(0,1),lwd=5, main = "Posterior (black) and Prior (red) distribution of APpre")
    #lines(1:1000/1000,dbeta(seq(0,1,length.out = 1000),a,b),type = "l",col="red",lwd=5)
    # }
  })
```

<!--True, single, zero -->

```{r echo=FALSE, eval=(pre=="True prevalence" & zero=="Yes")}
renderPlot({
     source("Functions/Jags_TruePreZero.R",local=TRUE)
    paste("EISAI EDO TRUEYES")

    post <-  data.frame(density=data.frame(density=Model1.mcmc[[1]][,1])[,1])
    pri <-  data.frame(density=rbeta(10000,shape1 = priors$prior$a,shape2=priors$prior$b))
    Lik <- data.frame(density=rbinom(n = 10000, size =  input$n, prob = input$y/input$n))
    post$dist <- 'posterior' ; pri$dist <- 'prior' ; Lik$dist <- 'likelihood'
    triple <- rbind(post, pri, Lik)
    p1<-ggplot(triple, aes(density, fill = dist)) + geom_density(alpha = 0.2)+
      xlim(0, 1)+ theme(legend.position="top")
    p1
     # S <- ggs(Model1.mcmc)
   # p2<-ggs_traceplot(S)
   # gridExtra::grid.arrange(p1,p2,ncol=2)
    
  # plot(density(Model1.mcmc[[1]][,5]),ylim=c(0,100),xlim=c(0,1),lwd=5, main = "Posterior (black) and Prior (red) distribution of TRpre")
   # lines(1:1000/1000,dbeta(seq(0,1,length.out = 1000),1.80,21),type = "l",col="red",lwd=5)
    # }
  })

```

<!--Apparent, single, zero -->

<!--Apparent, multiple, no zero -->

<!--True, multiple, no zero -->

<!--Apparent, multiple, zero -->

<!--True, multiple, zero NEEDS FIXING in the END --> 

```{r echo=FALSE, eval=(pre=="True prevalence" & pop!="Single population")}
renderPlot({
     source("Functions/Jags_MultipleGroupsPre.R",local=TRUE)

  post <-  data.frame(density=data.frame(density=Model1.mcmc[[1]][,1])[,1])
    pri <-  data.frame(density=rbeta(10000,shape1 = priors$prior$a,shape2=priors$prior$b))
    Lik <- data.frame(density=rbinom(n = 10000, size =  input$n, prob = input$y/input$n)/input$n)
    post$dist <- 'posterior' ; pri$dist <- 'prior' ; Lik$dist <- 'likelihood'
    triple <- rbind(post, pri, Lik)
    p1<-ggplot(triple, aes(density, fill = dist)) + geom_density(alpha = 0.2)+
      xlim(0, 1)+ theme(legend.position="top")
    p1
     # S <- ggs(Model1.mcmc)
   # p2<-ggs_traceplot(S)
   # gridExtra::grid.arrange(p1,p2,ncol=2)
    
  # plot(density(Model1.mcmc[[1]][,5]),ylim=c(0,100),xlim=c(0,1),lwd=5, main = "Posterior (black) and Prior (red) distribution of TRpre")
   # lines(1:1000/1000,dbeta(seq(0,1,length.out = 1000),1.80,21),type = "l",col="red",lwd=5)
    # }
  })

```


------------------------------------------------------------------------

------------------------------------------------------------------------

## Diagnostics

```{r echo=FALSE, figures-side, fig.show="hold", out.width="33%"}
    oldw <- getOption("warn") # silence warnings for diagnostic plots
    options(warn = -1)
    S<-ggs(Model1.mcmc)
    ggs_histogram(S)
    ggs_density(S)
    ggs_traceplot(S)
    ggs_running(S)
    ggs_compare_partial(S)
    ggs_autocorrelation(S)
    options(warn = oldw) # turn back warnings to previous level
# Model1fit<-as.mcmc(Model1.mcmc)
# traceplot(Model1.mcmc)
# autocorr.plot(Model1fit)
# geweke.plot(Model1fit)
```

------------------------------------------------------------------------

End of tPriors report.
